<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; flex-direction: column; height: 100vh; font-family: "Microsoft YaHei", sans-serif;}
        
        /* --- æ ¸å¿ƒå®¹å™¨ --- */
        .content-container {
            flex: 1; width: 100%; height: 100%; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        video, img, iframe { width: 100%; height: 100%; display: none; border: none; object-fit: contain; }
        .active { display: block !important; }

        /* --- é¡¶éƒ¨æ„Ÿåº”åŒºåŸŸ --- */
        .top-hover-zone {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px; z-index: 200;
            display: flex; flex-direction: column;
        }
        .controls {
            width: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; 
            box-sizing: border-box; font-size: clamp(6px, 2vw, 16px); padding: 0.5em 0.6em; 
            opacity: 0; transform: translateY(-100%); transition: all 0.3s ease; -webkit-app-region: drag; 
        }
        .top-hover-zone:hover .controls { opacity: 1; transform: translateY(0); }
        .controls.mini input { display: none !important; }
        .controls.mini { justify-content: center; gap: 0.6em; }
        
        /* æ§ä»¶æ ·å¼ */
        input { 
            flex: 1; font-size: 1em; margin-right: 0.6em; outline: none; 
            padding: 0.3em 0.5em; background: #333; color: white; border: 1px solid #555; border-radius: 0.3em;
            -webkit-app-region: no-drag; 
        }
        button { 
            font-size: 1em; cursor: pointer; margin-right: 0; padding: 0.3em 0.5em; 
            background: #444; color: white; border: 1px solid #666; border-radius: 0.3em;
            -webkit-app-region: no-drag; display: flex; align-items: center; justify-content: center;
            min-width: 2em; height: 2em; 
        }
        button:hover { background: #666; }
        #btnBoss { color: #aaa; border-color: #888; }
        #btnBoss:hover { color: #fff; background: #666; }
        .controls > * { margin-right: 0.4em; }
        .controls.mini > * { margin-right: 0; } 
        .btn-move {
            -webkit-app-region: no-drag; display: inline-flex; justify-content: center; align-items: center; 
            box-sizing: border-box; width: 2em; height: 2em; font-size: 1em; cursor: move; 
            background: #2b5c82; color: white; border: 1px solid #3e7ca8; border-radius: 0.3em;
            -webkit-user-select: none; user-select: none;
        }
        .btn-move:hover { background: #3e7ca8; }
        #btnTop { font-size: 1em; padding: 0.3em 0.5em; }
        .win-controls { display: flex; align-items: center; gap: 0.4em; margin-left: auto; }
        .controls.mini .win-controls { margin-left: 0; }
        .btn-close { background: #c00; border-color: #a00; }

        /* --- æ–°å¢ï¼šæ¿€æ´»é®ç½©å±‚ --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #1a1a1a; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        .login-box {
            background: #2a2a2a; padding: 30px; border-radius: 8px; width: 320px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); color: #fff;
        }
        .login-box h2 { margin-top: 0; margin-bottom: 20px; }
        .login-box input { width: 100%; margin-bottom: 15px; box-sizing: border-box; background: #fff; color: #000; border: none; padding: 10px; }
        .login-box button { width: 100%; background: #2ea44f; border: none; padding: 10px; font-weight: bold; color: white; cursor: pointer; }
        .login-box button:hover { background: #2c974b; }
        #act-msg { margin-top: 15px; font-size: 12px; min-height: 1.5em; color: #ff5555; }

    </style>
</head>
<body>
    
    <div id="login-overlay">
        <div class="login-box">
            <h2>è¯·è¾“å…¥æ¿€æ´»ç </h2>
            <input type="text" id="license-input" placeholder="è¾“å…¥ License Key" autocomplete="off">
            <button onclick="tryActivate()">ç«‹å³æ¿€æ´»</button>
            <p id="act-msg"></p>
        </div>
    </div>

    <div class="top-hover-zone">
        <div class="controls" id="ctrlBar">
            <input type="text" id="urlInput" placeholder="æ”¯æŒ è§†é¢‘ / å›¾ç‰‡ / PDF æ‹–æ‹½">
            
            <button id="btnBoss" onclick="toggleBoss()" title="è€æ¿é”® (Alt+Q)">ğŸ‘»</button>
            <button id="btnTop" onclick="toggleTop()" title="ç½®é¡¶">ğŸ“Œ</button>
            <button onclick="playMedia()" title="æ’­æ”¾/åˆ·æ–°">â–¶</button>
            <button onclick="toggleSize()" title="åˆ‡æ¢æ¨¡å¼">ğŸ“º</button>
            
            <div class="win-controls" id="winBtns" style="display:none;">
                <div class="btn-move" onmousedown="startDrag()" title="æ‹–åŠ¨">âœ¥</div>
                <button onclick="winMin()">-</button>
                <button class="btn-close" onclick="winClose()">Ã—</button>
            </div>
        </div>
    </div>

    <div class="content-container">
        <video id="vPlayer" controls autoplay></video>
        <img id="imgViewer" alt="Image Viewer">
        <iframe id="pdfViewer"></iframe>
    </div>

    <script>
        const PORT = "{{PORT}}";
        const video = document.getElementById('vPlayer');
        const img = document.getElementById('imgViewer');
        const pdf = document.getElementById('pdfViewer');
        const input = document.getElementById('urlInput');
        const winBtns = document.getElementById('winBtns');
        const ctrlBar = document.getElementById('ctrlBar');
        const overlay = document.getElementById('login-overlay');
        const actMsg = document.getElementById('act-msg');
        
        let isMini = false;
        let isTop = false;
        let hls = null;
        let currentType = 'video';

        // --- æ¿€æ´»é€»è¾‘ ---
        window.onload = async () => {
            // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ¿€æ´»çŠ¶æ€
            if (window.checkLicense) {
                try {
                    const status = await window.checkLicense();
                    if (status.valid) {
                        overlay.style.display = 'none'; // å·²æ¿€æ´»ï¼Œéšè—é®ç½©
                        console.log(status.msg);
                    } else {
                        actMsg.innerText = status.msg;
                    }
                } catch (e) { console.error(e); }
            }
        };

        async function tryActivate() {
            const code = document.getElementById('license-input').value;
            if(!code) return;
            actMsg.innerText = "éªŒè¯ä¸­...";
            try {
                const res = await window.activate(code);
                if (res.success) {
                    actMsg.style.color = "#4caf50";
                    actMsg.innerText = res.msg;
                    setTimeout(() => { overlay.style.display = 'none'; }, 1000);
                } else {
                    actMsg.style.color = "#ff5555";
                    actMsg.innerText = res.msg;
                }
            } catch (e) { actMsg.innerText = "æ¥å£é”™è¯¯"; }
        }

        // --- åŸæœ‰åŠŸèƒ½é€»è¾‘ ---

        function playInput() { playMedia(); }
        
        function playMedia() {
            let val = input.value;
            if (!val) return;
            if (!val.startsWith('http') && !val.startsWith('blob:')) {
                val = `http://127.0.0.1:${PORT}/${val}`;
            }
            loadResource(val);
        }

        function loadResource(src) {
            video.pause();
            video.classList.remove('active');
            img.classList.remove('active');
            pdf.classList.remove('active');
            
            const cleanSrc = src.split('?')[0].toLowerCase();
            
            if (cleanSrc.match(/\.(jpg|jpeg|png|gif|webp|svg)$/)) {
                currentType = 'image';
                img.src = src;
                img.classList.add('active');
            } else if (cleanSrc.endsWith('.pdf')) {
                currentType = 'pdf';
                pdf.src = src;
                pdf.classList.add('active');
            } else {
                currentType = 'video';
                video.classList.add('active');
                if (hls) { hls.destroy(); hls = null; }
                if (cleanSrc.includes('.m3u8')) {
                    if (Hls.isSupported()) {
                        hls = new Hls();
                        hls.loadSource(src);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.MANIFEST_PARSED, function() { video.play(); });
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = src;
                        video.addEventListener('loadedmetadata', function() { video.play(); });
                    }
                } else {
                    video.src = src;
                    video.play();
                }
            }
        }

        function startDrag() { if(window.winMove) window.winMove(); }
        function winMin() { if(window.winMin) window.winMin(); }
        function winClose() { if(window.winClose) window.winClose(); }
        function toggleBoss() { if(window.bossKey) window.bossKey(); }

        function toggleSize() {
            isMini = !isMini;
            if(window.toggleMode) window.toggleMode(isMini);
            if(isMini) {
                ctrlBar.classList.add('mini');
                winBtns.style.display = 'flex';
                document.querySelector('.top-hover-zone').style.height = '100%'; 
            } else {
                ctrlBar.classList.remove('mini');
                winBtns.style.display = 'none';
                document.querySelector('.top-hover-zone').style.height = '80px';
            }
        }

        function toggleTop() {
            isTop = !isTop;
            if(window.setTop) window.setTop(isTop);
            const btn = document.getElementById('btnTop');
            if (isTop) {
                btn.style.background = '#2ea44f'; btn.style.borderColor = '#2ea44f';
            } else {
                btn.style.background = '#444'; btn.style.borderColor = '#666';
            }
        }

        document.body.addEventListener('dragover', e => e.preventDefault());
        document.body.addEventListener('drop', e => {
            e.preventDefault();
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                const localUrl = URL.createObjectURL(file);
                const type = file.type;
                
                video.pause();
                video.classList.remove('active');
                img.classList.remove('active');
                pdf.classList.remove('active');

                if (type.startsWith('image/')) {
                    img.src = localUrl;
                    img.classList.add('active');
                } else if (type === 'application/pdf') {
                    pdf.src = localUrl;
                    pdf.classList.add('active');
                } else {
                    video.classList.add('active');
                    loadResource(localUrl);
                }
                input.value = file.name;
            }
        });
        
        document.body.addEventListener('dblclick', (e) => {
            if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
            if(e.target.classList.contains('btn-move')) return; 
            if(e.target.closest('.controls')) return; 
            if (currentType === 'video') {
                if(video.paused) video.play(); else video.pause();
            }
        });
    </script>
</body>
</html>