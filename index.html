<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <style>
        body { 
            margin: 0; background: #000; overflow: hidden; 
            display: flex; flex-direction: column; height: 100vh; 
            font-family: "Microsoft YaHei", sans-serif; 
            user-select: none; 
            outline: none;
        }
        
        /* --- æ ¸å¿ƒå®¹å™¨ --- */
        .content-container {
            flex: 1; width: 100%; height: 100%; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        video, img, iframe { width: 100%; height: 100%; display: none; border: none; object-fit: contain; }
        .active { display: block !important; }

        /* --- é¡¶éƒ¨æ„Ÿåº”åŒºåŸŸ --- */
        .top-hover-zone {
            position: absolute; top: 0; left: 0; width: 100%; 
            height: 30%; /* ä¿è¯åœ¨è¿·ä½ æ¨¡å¼ä¸‹ä¹Ÿèƒ½å®¹æ˜“è§¦å‘ */
            min-height: 40px; 
            z-index: 200;
            display: flex; flex-direction: column;
        }
        .top-hover-zone:hover .controls { opacity: 1; transform: translateY(0); }

        /* --- æ§åˆ¶æ¡å®¹å™¨ --- */
        .controls {
            width: 100%; height: auto; 
            background: rgba(0,0,0,0.85); 
            position: relative; 
            opacity: 0; transform: translateY(-100%); transition: all 0.3s ease;
            
            /* âœ… ä¿®æ”¹è¿™é‡Œï¼šæœ€å°å­—å·æ”¹ä¸º 4pxï¼Œæœ€å¤§ 16px */
            /* ç•Œé¢æ‰€æœ‰å…ƒç´ å¤§å°éƒ½ä¼šéšè¿™ä¸ªå­—ä½“å¤§å°è‡ªåŠ¨ç¼©æ”¾ */
            font-size: clamp(4px, 3vw, 16px);
        }

        /* --- æ‹–åŠ¨å±‚ (åº•å±‚) --- */
        .drag-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            -webkit-app-region: drag; 
            z-index: 0; 
        }

        /* --- æŒ‰é’®å±‚ (ä¸Šå±‚) --- */
        .control-items {
            position: relative; z-index: 10; 
            display: flex; align-items: center; 
            padding: 0.5em 0.6em; /* é—´è·ä¹Ÿä¼šéšå­—å·ç¼©å° */
            box-sizing: border-box; width: 100%;
            pointer-events: none; 
        }

        /* è®©æŒ‰é’®æ¢å¤ç‚¹å‡» */
        .control-items > * {
            pointer-events: auto; 
            -webkit-app-region: no-drag; 
        }

        /* --- æ§ä»¶æ ·å¼ --- */
        input { 
            flex: 1; 
            font-size: inherit; /* ç»§æ‰¿çˆ¶çº§å¤§å° */
            margin-right: 0.6em; outline: none; 
            padding: 0.3em 0.5em; background: #333; color: white; border: 1px solid #555; border-radius: 0.3em;
            height: 2.2em; 
        }
        
        button, .btn-move { 
            font-size: inherit; /* ç»§æ‰¿çˆ¶çº§å¤§å° */
            cursor: pointer; margin-right: 0.4em; padding: 0;
            background: #444; color: white; border: 1px solid #666; border-radius: 0.3em;
            display: flex; align-items: center; justify-content: center;
            width: 2.2em; height: 2.2em; /* å®½é«˜éšå­—ä½“è‡ªåŠ¨ç¼©æ”¾ */
            box-sizing: border-box;
        }
        
        button:hover { background: #666; }
        
        #btnBoss { color: #aaa; border-color: #888; }
        #btnBoss:hover { color: #fff; background: #666; }
        
        .btn-move { cursor: move; background: #2b5c82; border: 1px solid #3e7ca8; }
        .btn-move:hover { background: #3e7ca8; }
        
        .btn-close { background: #c00; border-color: #a00; }
        .btn-close:hover { background: #f00; }

        /* --- æ¨¡å¼åˆ‡æ¢é€»è¾‘ --- */
        .only-mini { display: none; } 
        
        .controls.mini .control-items { justify-content: center; gap: 0.4em; }
        .controls.mini input { display: none; }
        .controls.mini .only-mini { display: flex; } 
        .controls.mini button, .controls.mini .btn-move { margin-right: 0; } 


        /* --- æ¿€æ´»é®ç½©å±‚ --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #1a1a1a; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            -webkit-app-region: no-drag; 
        }
        .login-box {
            background: #2a2a2a; padding: 30px; border-radius: 8px; width: 320px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); color: #fff;
        }
        .login-box input { width: 100%; margin-bottom: 15px; box-sizing: border-box; background: #fff; color: #000; border: none; padding: 10px; font-size: 16px;}
        .login-box button { width: 100%; background: #2ea44f; border: none; padding: 10px; font-weight: bold; color: white; cursor: pointer; font-size: 16px;}
        #act-msg { margin-top: 15px; font-size: 12px; min-height: 1.5em; color: #ff5555; }

    </style>
</head>
<body tabindex="0">
    
    <div id="login-overlay">
        <div class="login-box">
            <h2>è¯·è¾“å…¥æ¿€æ´»ç </h2>
            <input type="text" id="license-input" placeholder="è¾“å…¥ License Key" autocomplete="off">
            <button onclick="tryActivate()">ç«‹å³æ¿€æ´»</button>
            <p id="act-msg"></p>
        </div>
    </div>

    <div class="top-hover-zone">
        <div class="controls" id="ctrlBar">
            <div class="drag-layer"></div>

            <div class="control-items">
                <input type="text" id="urlInput" placeholder="æ”¯æŒ è§†é¢‘ / å›¾ç‰‡ / PDF æ‹–æ‹½">
                
                <button id="btnBoss" onclick="clickBtn(toggleBoss)" title="è€æ¿é”® (Alt+Q)">ğŸ‘»</button>
                <button id="btnTop" onclick="clickBtn(toggleTop)" title="ç½®é¡¶">ğŸ“Œ</button>
                <button onclick="clickBtn(playMedia)" title="æ’­æ”¾/åˆ·æ–°">â–¶</button>
                <button onclick="clickBtn(toggleSize)" title="åˆ‡æ¢æ¨¡å¼">ğŸ“º</button>
                
                <div class="btn-move only-mini" onmousedown="startDrag()" title="æ‹–åŠ¨">âœ¥</div>
                <button class="only-mini" onclick="clickBtn(doMin)" title="æœ€å°åŒ–">-</button>
                <button class="btn-close only-mini" onclick="clickBtn(doClose)" title="å…³é—­">Ã—</button>
            </div>
        </div>
    </div>

    <div class="content-container">
        <video id="vPlayer" controls autoplay></video>
        <img id="imgViewer" alt="Image Viewer">
        <iframe id="pdfViewer"></iframe>
    </div>

    <script>
        const PORT = "{{PORT}}";
        const video = document.getElementById('vPlayer');
        const img = document.getElementById('imgViewer');
        const pdf = document.getElementById('pdfViewer');
        const input = document.getElementById('urlInput');
        const ctrlBar = document.getElementById('ctrlBar');
        const overlay = document.getElementById('login-overlay');
        const actMsg = document.getElementById('act-msg');
        
        let isMini = false;
        let isTop = false;
        let hls = null;
        let currentType = 'video';

        // --- æŒ‰é’®ç‚¹å‡»å¤„ç† (ç„¦ç‚¹ä¿®å¤) ---
        function clickBtn(fn) {
            if (typeof fn === 'function') fn();
            // ç‚¹å‡»åå¼ºåˆ¶è®©æŒ‰é’®å¤±å»ç„¦ç‚¹ï¼Œé˜²æ­¢å æœ‰ç©ºæ ¼é”®
            setTimeout(() => {
                if (document.activeElement) document.activeElement.blur();
                document.body.focus();
                window.focus();
            }, 50);
        }

        // åç«¯å‡½æ•°åŒ…è£…
        function doMin() { if(window.winMin) window.winMin(); }
        function doClose() { if(window.winClose) window.winClose(); }
        function startDrag() { if(window.winMove) window.winMove(); }
        function toggleBoss() { if(window.bossKey) window.bossKey(); }
        
        function toggleSize() {
            isMini = !isMini;
            if(window.toggleMode) window.toggleMode(isMini);
            if(isMini) {
                ctrlBar.classList.add('mini');
            } else {
                ctrlBar.classList.remove('mini');
            }
        }
        
        function toggleTop() {
            isTop = !isTop;
            if(window.setTop) window.setTop(isTop);
            const btn = document.getElementById('btnTop');
            btn.style.background = isTop ? '#2ea44f' : '#444';
            btn.style.borderColor = isTop ? '#2ea44f' : '#666';
        }

        // --- æ¿€æ´»é€»è¾‘ ---
        window.onload = async () => {
            document.body.focus();
            if (window.checkLicense) {
                try {
                    const status = await window.checkLicense();
                    if (status.valid) {
                        overlay.style.display = 'none';
                        console.log(status.msg);
                    } else {
                        actMsg.innerText = status.msg;
                    }
                } catch (e) { console.error(e); }
            }
        };

        async function tryActivate() {
            const code = document.getElementById('license-input').value;
            if(!code) return;
            actMsg.innerText = "éªŒè¯ä¸­...";
            try {
                const res = await window.activate(code);
                if (res.success) {
                    actMsg.style.color = "#4caf50";
                    actMsg.innerText = res.msg;
                    setTimeout(() => { overlay.style.display = 'none'; }, 1000);
                } else {
                    actMsg.style.color = "#ff5555";
                    actMsg.innerText = res.msg;
                }
            } catch (e) { actMsg.innerText = "æ¥å£é”™è¯¯"; }
        }

        // --- åª’ä½“é€»è¾‘ ---
        function playMedia() {
            let val = input.value;
            if (!val) return;
            if (!val.startsWith('http') && !val.startsWith('blob:')) {
                val = `http://127.0.0.1:${PORT}/${val}`;
            }
            loadResource(val);
        }

        function loadResource(src) {
            video.pause();
            video.classList.remove('active');
            img.classList.remove('active');
            pdf.classList.remove('active');
            
            const cleanSrc = src.split('?')[0].toLowerCase();
            
            if (cleanSrc.match(/\.(jpg|jpeg|png|gif|webp|svg)$/)) {
                currentType = 'image';
                img.src = src;
                img.classList.add('active');
            } else if (cleanSrc.endsWith('.pdf')) {
                currentType = 'pdf';
                pdf.src = src;
                pdf.classList.add('active');
            } else {
                currentType = 'video';
                video.classList.add('active');
                if (hls) { hls.destroy(); hls = null; }
                if (cleanSrc.includes('.m3u8')) {
                    if (Hls.isSupported()) {
                        hls = new Hls();
                        hls.loadSource(src);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.MANIFEST_PARSED, function() { video.play(); });
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = src;
                        video.addEventListener('loadedmetadata', function() { video.play(); });
                    }
                } else {
                    video.src = src;
                    video.play();
                }
            }
        }

        // --- å¿«æ·é”®ç›‘å¬ ---
        window.addEventListener('keydown', (e) => {
            if (document.activeElement.tagName === 'INPUT') return;

            switch (e.code) {
                case 'Space': 
                    e.preventDefault(); 
                    if (currentType === 'video') {
                        video.paused ? video.play() : video.pause();
                    }
                    break;
                case 'ArrowRight': 
                    if (currentType === 'video') {
                        video.currentTime = Math.min(video.duration, video.currentTime + 5);
                    }
                    break;
                case 'ArrowLeft': 
                    if (currentType === 'video') {
                        video.currentTime = Math.max(0, video.currentTime - 5);
                    }
                    break;
            }
        });

        // é¼ æ ‡ç‚¹å‡»å½’è¿˜ç„¦ç‚¹
        document.addEventListener('mousedown', (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                 setTimeout(() => { document.body.focus(); }, 10);
            }
        });

        document.body.addEventListener('dragover', e => e.preventDefault());
        document.body.addEventListener('drop', e => {
            e.preventDefault();
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                const localUrl = URL.createObjectURL(file);
                input.value = file.name;
                
                const type = file.type;
                if (type.startsWith('image/')) {
                    loadResource(localUrl);
                } else if (type === 'application/pdf') {
                    loadResource(localUrl);
                } else {
                    loadResource(localUrl);
                }
            }
        });
        
        document.body.addEventListener('dblclick', (e) => {
            if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
            if(e.target.closest('.controls')) return; 
            if (currentType === 'video') {
                video.paused ? video.play() : video.pause();
            }
        });
    </script>
</body>
</html>