<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* --- æ ¸å¿ƒå®¹å™¨ï¼šæ‰€æœ‰å†…å®¹éƒ½é“ºæ»¡å…¨å± --- */
        .content-container {
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex; 
            justify-content: center; 
            align-items: center;
        }

        /* è§†é¢‘ã€å›¾ç‰‡ã€PDF é»˜è®¤éšè— */
        video, img, iframe { 
            width: 100%; 
            height: 100%; 
            display: none; /* é»˜è®¤éšè— */
            border: none;
        }
        
        /* è§†é¢‘å’Œå›¾ç‰‡ä¿æŒæ¯”ä¾‹ */
        video, img { object-fit: contain; }
        
        /* æ¿€æ´»çŠ¶æ€ */
        .active { display: block !important; }

        /* --- é¡¶éƒ¨æ„Ÿåº”åŒºåŸŸ --- */
        .top-hover-zone {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px; z-index: 200;
            display: flex; flex-direction: column;
        }

        /* --- æ§åˆ¶æ  --- */
        .controls {
            width: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; align-items: center; 
            box-sizing: border-box;
            font-size: clamp(6px, 2vw, 16px); 
            padding: 0.5em 0.6em; 
            opacity: 0; transform: translateY(-100%); transition: all 0.3s ease;
            -webkit-app-region: drag; 
        }

        .top-hover-zone:hover .controls { opacity: 1; transform: translateY(0); }
        
        .controls.mini input { display: none !important; }
        .controls.mini { justify-content: center; gap: 0.6em; }
        
        /* æ§ä»¶æ ·å¼ */
        input { 
            flex: 1; font-size: 1em; margin-right: 0.6em; outline: none; 
            padding: 0.3em 0.5em; 
            background: #333; color: white; border: 1px solid #555; border-radius: 0.3em;
            -webkit-app-region: no-drag; 
        }
        
        button { 
            font-size: 1em; cursor: pointer; margin-right: 0; 
            padding: 0.3em 0.5em; 
            background: #444; color: white; border: 1px solid #666; border-radius: 0.3em;
            -webkit-app-region: no-drag;
            display: flex; align-items: center; justify-content: center;
            min-width: 2em; height: 2em; 
        }
        button:hover { background: #666; }
        
        #btnBoss { color: #aaa; border-color: #888; }
        #btnBoss:hover { color: #fff; background: #666; }

        .controls > * { margin-right: 0.4em; }
        .controls.mini > * { margin-right: 0; } 

        .btn-move {
            -webkit-app-region: no-drag; 
            display: inline-flex; justify-content: center; align-items: center; box-sizing: border-box;
            width: 2em; height: 2em; font-size: 1em; 
            cursor: move; 
            background: #2b5c82; color: white; border: 1px solid #3e7ca8; border-radius: 0.3em;
            -webkit-user-select: none; user-select: none;
        }
        .btn-move:hover { background: #3e7ca8; }

        #btnTop { font-size: 1em; padding: 0.3em 0.5em; }
        .win-controls { display: flex; align-items: center; gap: 0.4em; margin-left: auto; }
        .controls.mini .win-controls { margin-left: 0; }
        .btn-close { background: #c00; border-color: #a00; }
    </style>
</head>
<body>
    
    <div class="top-hover-zone">
        <div class="controls" id="ctrlBar">
            <input type="text" id="urlInput" placeholder="æ”¯æŒ è§†é¢‘ / å›¾ç‰‡ / PDF æ‹–æ‹½">
            
            <button id="btnBoss" onclick="toggleBoss()" title="è€æ¿é”® (Alt+Q)">ğŸ‘»</button>
            <button id="btnTop" onclick="toggleTop()" title="ç½®é¡¶">ğŸ“Œ</button>
            <button onclick="playMedia()" title="æ’­æ”¾/åˆ·æ–°">â–¶</button>
            <button onclick="toggleSize()" title="åˆ‡æ¢æ¨¡å¼">ğŸ“º</button>
            
            <div class="win-controls" id="winBtns" style="display:none;">
                <div class="btn-move" onmousedown="startDrag()" title="æ‹–åŠ¨">âœ¥</div>
                <button onclick="winMin()">-</button>
                <button class="btn-close" onclick="winClose()">Ã—</button>
            </div>
        </div>
    </div>

    <div class="content-container">
        <video id="vPlayer" controls autoplay></video>
        <img id="imgViewer" alt="Image Viewer">
        <iframe id="pdfViewer"></iframe>
    </div>

    <script>
        const PORT = "{{PORT}}";
        const video = document.getElementById('vPlayer');
        const img = document.getElementById('imgViewer');
        const pdf = document.getElementById('pdfViewer');
        const input = document.getElementById('urlInput');
        const winBtns = document.getElementById('winBtns');
        const ctrlBar = document.getElementById('ctrlBar');
        
        let isMini = false;
        let isTop = false;
        let hls = null;
        let currentType = 'video'; // video, image, pdf

        function playInput() { playMedia(); } // å…¼å®¹æ—§ä¹ æƒ¯
        
        function playMedia() {
            let val = input.value;
            if (!val) return;
            // å¦‚æœä¸æ˜¯ä»¥ http æˆ– blob å¼€å¤´ï¼Œè¯´æ˜æ˜¯ç›¸å¯¹è·¯å¾„ï¼ŒåŠ ä¸Šæœ¬åœ°æœåŠ¡å‰ç¼€
            if (!val.startsWith('http') && !val.startsWith('blob:')) {
                val = `http://127.0.0.1:${PORT}/${val}`;
            }
            loadResource(val);
        }

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ™ºèƒ½èµ„æºåŠ è½½å™¨
        function loadResource(src) {
            // 1. å…ˆé‡ç½®æ‰€æœ‰æ˜¾ç¤º
            video.pause();
            video.classList.remove('active');
            img.classList.remove('active');
            pdf.classList.remove('active');
            
            // ç®€å•åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼ˆå–åç¼€ï¼Œå¿½ç•¥å¤§å°å†™ï¼Œå¿½ç•¥æŸ¥è¯¢å‚æ•°ï¼‰
            // å¦‚æœæ˜¯ blob: å¼€å¤´çš„ï¼Œé€šå¸¸æ˜¯æ‹–æ‹½è¿›æ¥çš„ï¼Œæˆ‘ä»¬éœ€è¦æ›´å¤æ‚çš„åˆ¤æ–­ï¼Œæˆ–è€…ç›´æ¥æ ¹æ®æ‹–æ‹½æ—¶çš„æ–‡ä»¶å¯¹è±¡åˆ¤æ–­
            // è¿™é‡Œä¸»è¦å¤„ç† input è¾“å…¥çš„ URL å­—ç¬¦ä¸²
            
            const cleanSrc = src.split('?')[0].toLowerCase();
            
            if (cleanSrc.endsWith('.jpg') || cleanSrc.endsWith('.jpeg') || cleanSrc.endsWith('.png') || cleanSrc.endsWith('.gif') || cleanSrc.endsWith('.webp') || cleanSrc.endsWith('.svg')) {
                // --- å›¾ç‰‡æ¨¡å¼ ---
                currentType = 'image';
                img.src = src;
                img.classList.add('active');
                
            } else if (cleanSrc.endsWith('.pdf')) {
                // --- PDFæ¨¡å¼ ---
                currentType = 'pdf';
                pdf.src = src;
                pdf.classList.add('active');
                
            } else {
                // --- é»˜è®¤ä¸ºè§†é¢‘æ¨¡å¼ ---
                currentType = 'video';
                video.classList.add('active');
                
                if (hls) { hls.destroy(); hls = null; }
                
                if (cleanSrc.includes('.m3u8')) {
                    if (Hls.isSupported()) {
                        hls = new Hls();
                        hls.loadSource(src);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.MANIFEST_PARSED, function() { video.play(); });
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = src;
                        video.addEventListener('loadedmetadata', function() { video.play(); });
                    }
                } else {
                    video.src = src;
                    video.play();
                }
            }
        }

        function startDrag() { window.winMove(); }
        function toggleBoss() { window.bossKey(); }

        function toggleSize() {
            isMini = !isMini;
            toggleMode(isMini); 
            if(isMini) {
                ctrlBar.classList.add('mini');
                winBtns.style.display = 'flex';
                document.querySelector('.top-hover-zone').style.height = '100%'; 
            } else {
                ctrlBar.classList.remove('mini');
                winBtns.style.display = 'none';
                document.querySelector('.top-hover-zone').style.height = '80px';
            }
        }

        function toggleTop() {
            isTop = !isTop;
            window.setTop(isTop);
            const btn = document.getElementById('btnTop');
            if (isTop) {
                btn.style.background = '#2ea44f'; btn.style.borderColor = '#2ea44f';
            } else {
                btn.style.background = '#444'; btn.style.borderColor = '#666';
            }
        }

        // æ‹–æ‹½æ–‡ä»¶æ”¯æŒ
        document.body.addEventListener('dragover', e => e.preventDefault());
        document.body.addEventListener('drop', e => {
            e.preventDefault();
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                const localUrl = URL.createObjectURL(file);
                
                // æ‹–æ‹½æ—¶ï¼Œæ–‡ä»¶å¯¹è±¡é‡Œæœ‰ type å±æ€§ï¼Œæ¯”åç¼€åæ›´å‡†
                const type = file.type;
                
                // é‡ç½®æ˜¾ç¤º
                video.pause();
                video.classList.remove('active');
                img.classList.remove('active');
                pdf.classList.remove('active');

                if (type.startsWith('image/')) {
                    img.src = localUrl;
                    img.classList.add('active');
                    input.value = file.name; // æ˜¾ç¤ºæ–‡ä»¶åæ–¹ä¾¿çœ‹
                } else if (type === 'application/pdf') {
                    pdf.src = localUrl;
                    pdf.classList.add('active');
                    input.value = file.name;
                } else {
                    // é»˜è®¤å½“è§†é¢‘
                    video.classList.add('active');
                    loadResource(localUrl); // å¤ç”¨ä¹‹å‰çš„è§†é¢‘åŠ è½½é€»è¾‘
                    input.value = file.name;
                }
            }
        });
        
        document.body.addEventListener('dblclick', (e) => {
            if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
            if(e.target.classList.contains('btn-move')) return; 
            if(e.target.closest('.controls')) return; 
            
            // åªæœ‰è§†é¢‘æ¨¡å¼æ‰å“åº”åŒå‡»æš‚åœ
            if (currentType === 'video') {
                if(video.paused) video.play(); else video.pause();
            }
        });
    </script>
</body>
</html>