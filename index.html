<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        .top-hover-zone {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px; z-index: 200;
            display: flex; flex-direction: column;
        }

        .controls {
            width: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; align-items: center; padding: 8px 10px; box-sizing: border-box;
            opacity: 0; transform: translateY(-100%); transition: all 0.3s ease;
            -webkit-app-region: drag; 
        }

        .top-hover-zone:hover .controls { opacity: 1; transform: translateY(0); }
        
        /* --- æ‘¸é±¼æ¨¡å¼ä¸‹çš„å¸ƒå±€ --- */
        .controls.mini input { display: none !important; }
        .controls.mini { justify-content: center; gap: 8px; }
        
        input { 
            flex: 1; font-size: 12px; margin-right: 8px; outline: none; padding: 4px; 
            background: #333; color: white; border: 1px solid #555; border-radius: 4px;
            -webkit-app-region: no-drag; 
        }
        button { 
            font-size: 14px; /*ç¨å¾®å¤§ä¸€ç‚¹ç‚¹è®©å›¾æ ‡æ¸…æ™°*/ cursor: pointer; margin-right: 0; 
            padding: 4px 6px; /* å¾®è°ƒpaddingè®©æŒ‰é’®æ›´æ–¹æ­£ */
            background: #444; color: white; border: 1px solid #666; border-radius: 4px;
            -webkit-app-region: no-drag;
            display: flex; align-items: center; justify-content: center; /* ç¡®ä¿å›¾æ ‡å±…ä¸­ */
        }
        button:hover { background: #666; }
        
        /* é€šç”¨é—´è· */
        .controls > * { margin-right: 5px; }
        .controls.mini > * { margin-right: 0; } 

        /* ç§»åŠ¨æ‰‹æŸ„ */
        .btn-move {
            -webkit-app-region: no-drag; 
            display: inline-flex; justify-content: center; align-items: center; box-sizing: border-box;
            width: 26px; height: 26px; /* è°ƒæ•´ä¸ºæ–¹å½¢ */ font-size: 14px; 
            cursor: move; 
            background: #2b5c82; color: white; border: 1px solid #3e7ca8; border-radius: 4px;
            -webkit-user-select: none; user-select: none;
        }
        .btn-move:hover { background: #3e7ca8; }

        #btnTop { font-size: 14px; padding: 4px 6px; }
        .win-controls { display: flex; align-items: center; gap: 5px; margin-left: auto; }
        .controls.mini .win-controls { margin-left: 0; }
        
        .btn-close { background: #c00; border-color: #a00; }
        .btn-close:hover { background: #f00; }
    </style>
</head>
<body>
    
    <div class="top-hover-zone">
        <div class="controls" id="ctrlBar">
            <input type="text" id="urlInput" placeholder="ç²˜è´´ .m3u8 é“¾æŽ¥ æˆ– æ‹–å…¥æ–‡ä»¶">
            
            <button id="btnTop" onclick="toggleTop()" title="ç½®é¡¶/å–æ¶ˆ">ðŸ“Œ</button>
            
            <button onclick="playInput()" title="æ’­æ”¾">â–¶</button>
            
            <button onclick="toggleSize()" title="åˆ‡æ¢æ¨¡å¼">ðŸ“º</button>
            
            <div class="win-controls" id="winBtns" style="display:none;">
                <div class="btn-move" onmousedown="startDrag()" title="æŒ‰ä½æ‹–åŠ¨çª—å£">âœ¥</div>
                <button onclick="winMin()" title="æœ€å°åŒ–">-</button>
                <button class="btn-close" onclick="winClose()" title="å…³é—­">Ã—</button>
            </div>
        </div>
    </div>

    <video id="vPlayer" controls autoplay></video>

    <script>
        const PORT = "{{PORT}}";
        const video = document.getElementById('vPlayer');
        const input = document.getElementById('urlInput');
        const winBtns = document.getElementById('winBtns');
        const ctrlBar = document.getElementById('ctrlBar');
        
        let isMini = false;
        let isTop = false;
        let hls = null;

        function playInput() {
            let val = input.value;
            if (!val) return;
            if (!val.startsWith('http') && !val.startsWith('blob:')) {
                val = `http://127.0.0.1:${PORT}/${val}`;
            }
            loadVideo(val);
        }

        function startDrag() {
            window.winMove();
        }

        function loadVideo(src) {
            if (hls) { hls.destroy(); hls = null; }
            if (src.includes('.m3u8')) {
                if (Hls.isSupported()) {
                    hls = new Hls();
                    hls.loadSource(src);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() { video.play(); });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = src;
                    video.addEventListener('loadedmetadata', function() { video.play(); });
                }
            } else {
                video.src = src;
                video.play();
            }
        }

        function toggleSize() {
            isMini = !isMini;
            toggleMode(isMini); 
            
            if(isMini) {
                ctrlBar.classList.add('mini');
                winBtns.style.display = 'flex';
                document.querySelector('.top-hover-zone').style.height = '100%'; 
            } else {
                ctrlBar.classList.remove('mini');
                winBtns.style.display = 'none';
                document.querySelector('.top-hover-zone').style.height = '80px';
            }
        }

        function toggleTop() {
            isTop = !isTop;
            window.setTop(isTop);
            const btn = document.getElementById('btnTop');
            if (isTop) {
                btn.style.background = '#2ea44f'; btn.style.borderColor = '#2ea44f';
            } else {
                btn.style.background = '#444'; btn.style.borderColor = '#666';
            }
        }

        document.body.addEventListener('dragover', e => e.preventDefault());
        document.body.addEventListener('drop', e => {
            e.preventDefault();
            if (e.dataTransfer.files.length > 0) {
                loadVideo(URL.createObjectURL(e.dataTransfer.files[0]));
            }
        });
        
        document.body.addEventListener('dblclick', (e) => {
            if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
            if(e.target.classList.contains('btn-move')) return; 
            if(e.target.closest('.controls')) return; 
            if(video.paused) video.play(); else video.pause();
        });
    </script>
</body>
</html>